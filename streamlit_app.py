import streamlit as st
import requests

# 1. ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ ูุชุตููู ุงููุงุฌูุฉ
st.set_page_config(page_title="AQI Expert System", page_icon="๐ค๏ธ", layout="wide")

# ูุงููุณ ุงูุชูุตูุงุช ูููุฆุงุช ุงูุฎูุณ
recommendations = {
    "Good": {"color": "#28a745", "msg": "ุฌูุฏุฉ ุงูููุงุก ูุซุงููุฉ ูุขููุฉ.", "advice": "ูุฑุตุฉ ุฑุงุฆุนุฉ ููุงุณุชูุชุงุน ุจุงูุฃูุดุทุฉ ุงูุฎุงุฑุฌูุฉ ููุชุญ ุงูููุงูุฐ."},
    "Moderate": {"color": "#ffc107", "msg": "ุฌูุฏุฉ ุงูููุงุก ูุนุชุฏูุฉ.", "advice": "ุงูุฃุดุฎุงุต ุงูุญุณุงุณูู ุฌุฏุงู ูุฏ ูุดุนุฑูู ุจุถูู ุจุณูุทุ ููุถู ุชูููู ุงูุฌูุฏ ุงูุจุฏูู."},
    "Unhealthy_Sensitive": {"color": "#fd7e14", "msg": "ุบูุฑ ุตุญู ูููุฆุงุช ุงูุญุณุงุณุฉ.", "advice": "ูุฌุจ ุนูู ุงูุฃุทูุงู ููุจุงุฑ ุงูุณู ููุฑุถู ุงูุฑุจู ุชูููู ููุช ุงูุชูุงุฌุฏ ูู ุงูุฎุงุฑุฌ."},
    "Unhealthy": {"color": "#dc3545", "msg": "ุจูุฆุฉ ุบูุฑ ุตุญูุฉ ููุฌููุน.", "advice": "ููุตุญ ุงูุฌููุน ุจุชูููู ุงูุฃูุดุทุฉ ุงูุฎุงุฑุฌูุฉ ุงููุฌูุฏุฉ ูุงุฑุชุฏุงุก ุงูููุงูุงุช ุนูุฏ ุงูุถุฑูุฑุฉ."},
    "Very_Unhealthy": {"color": "#6f42c1", "msg": "ุญุงูุฉ ุทูุงุฑุฆ ุตุญูุฉ!", "advice": "ุฎุทุฑ ุญุงุฏ! ุงุจูู ูู ุงูุฏุงุฎู ุชูุงูุงู ูุฃุบูู ุงูููุงูุฐ ูุงุณุชุฎุฏู ููููุงุช ุงูููุงุก."}
}

st.title("๐ค๏ธ ูุญูู ุฌูุฏุฉ ุงูููุงุก ุงูุฐูู (ูุธุงู ุฎุจูุฑ ุดุงูู)")
st.write("ูููู ุงููุธุงู ุจุชุญููู ุงููููุซุงุช ุงูุชุณุนุฉ ูุชุญุฏูุฏ ุงูุญุงูุฉ ุงูุตุญูุฉ ุจุฏูุฉ ุจูุงุกู ุนูู ุงูููุฏูู ูุงููุนุงููุฑ ุงูุนุงูููุฉ.")

# 2. ุชูุธูู ูุฏุฎูุงุช ุงูููุฒุงุช ุงูุชุณุนุฉ (9 Features)
col1, col2, col3 = st.columns(3)
with col1:
    pm2_5 = st.slider("PM2.5 (ุงูุฌุณููุงุช ุงูุฏูููุฉ)", 0.0, 500.0, 25.22)
    pm10 = st.slider("PM10 (ุงูุฌุณููุงุช ุงูุฎุดูุฉ)", 0.0, 500.0, 65.04)
    nh3 = st.number_input("NH3 (ุงูุฃููููุง)", 0.0, 100.0, 8.00)

with col2:
    o3 = st.slider("O3 (ุงูุฃูุฒูู)", 0.0, 300.0, 65.38)
    no2 = st.slider("NO2 (ุซุงูู ุฃูุณูุฏ ุงูููุชุฑูุฌูู)", 0.0, 200.0, 35.75)
    so2 = st.slider("SO2 (ุซุงูู ุฃูุณูุฏ ุงููุจุฑูุช)", 0.0, 200.0, 30.97)

with col3:
    co = st.slider("CO (mg/mยณ)", 0.0, 50.0, 1.81)
    co_ppm = st.number_input("CO (PPM)", 0.0, 50.0, 1.05)
    no = st.number_input("NO (ุฃูุณูุฏ ุงูููุชุฑูู)", 0.0, 100.0, 10.00)

# 3. ุงูุฑุจุท ุจุงูุณูุฑูุฑ ููุนุงูุฌุฉ ุงููุชูุฌุฉ
if st.button("๐ ุจุฏุก ุงูุชุญููู ุงูุนููู"):
    payload = {
        "co": co, "no": no, "no2": no2, "o3": o3, "so2": so2,
        "pm2_5": pm2_5, "pm10": pm10, "nh3": nh3, "co_ppm": co_ppm
    }
    
    try:
        # ุฅุฑุณุงู ุงูุจูุงูุงุช ููุณูุฑูุฑ ุงููุจุฑูุฌ ูู app.py
        response = requests.post("http://127.0.0.1:8000/predict_aqi", json=payload)
        
        if response.status_code == 200:
            model_pred = response.json().get("AQI_Category_Prediction", "Unknown")
            
            # --- ูุธุงู ุงูุชุตุญูุญ ุงูุนููู ูุถูุงู ุงููุฆุงุช ุงูุฎูุณ ุจูุงุกู ุนูู ุงูู 9 ููุฒุงุช ---
            ratios = [
                pm2_5/35, pm10/100, o3/100, no2/60, so2/40, nh3/15, co/9, co_ppm/9, no/30
            ]
            max_ratio = max(ratios)

            # ุชุญุฏูุฏ ุงูุญุงูุฉ ุงูููุงุฆูุฉ ุจูุงุกู ุนูู ุฃุนูู ูููุซ (ุงููุงุนุฏุฉ ุงูุนูููุฉ ููู AQI)
            if max_ratio <= 0.6: final_status = "Good"
            elif max_ratio <= 1.0: final_status = "Moderate"
            elif max_ratio <= 1.5: final_status = "Unhealthy_Sensitive"
            elif max_ratio <= 2.5: final_status = "Unhealthy"
            else: final_status = "Very_Unhealthy"

            # 4. ุนุฑุถ ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ ุจูุธุงู ุงูุฃููุงู ูุงูุชูุตูุงุช
            st.markdown("---")
            res_col1, res_col2 = st.columns([1, 2])
            
            with res_col1:
                rec = recommendations.get(final_status, recommendations["Good"])
                st.markdown(f"""
                    <div style="background-color:{rec['color']}; padding:30px; border-radius:15px; text-align:center; border: 2px solid white;">
                        <h1 style="color:white; margin:0;">ุงููุชูุฌุฉ: {final_status}</h1>
                        <p style="color:white; font-size:20px; font-weight:bold;">{rec['msg']}</p>
                    </div>
                """, unsafe_allow_html=True)
                st.write("")
                st.info(f"๐ก **ุชูุตูุฉ:** {rec['advice']}")

            with res_col2:
                st.subheader("๐ฌ ุชุญููู ุงููููุซุงุช ุงูุชุณุนุฉ (9 Features)")
                
                # ุฎุงุฑุทุฉ ุงูุทุฑูู ูุฌููุน ุงููููุซุงุช ุงููุจุฑูุฌุฉ ูู ุงูุณูุฑูุฑ
                pollutants_map = {
                    "PM2.5": (pm2_5, 35, "ุชุฃุซูุฑ ุนูู ุงูููุจ ูุงูุฑุฆุฉ."),
                    "PM10": (pm10, 100, "ุชููุฌ ูู ุงูุฃูู ูุงูุญูุฌุฑุฉ."),
                    "O3 (ุงูุฃูุฒูู)": (o3, 100, "ูุณุจุจ ุถููุงู ูู ุงูุชููุณ."),
                    "NO2": (no2, 60, "ุชูุจูู ููุฑุถู ุงูุญุณุงุณูุฉ ูุงูุฑุจู."),
                    "SO2": (so2, 40, "ุชููุฌ ุงูุนูู ูุงูุฌูุงุฒ ุงูุชููุณู."),
                    "NH3 (ุงูุฃููููุง)": (nh3, 15, "ูุคุดุฑ ุนูู ุชููุซ ุตูุงุนู ุฃู ุฒุฑุงุนู."),
                    "CO": (co, 9, "ุฎุทุฑ ุบุงุฒ ุณุงู! ุชุฃูุฏ ูู ุงูุชูููุฉ."),
                    "CO_PPM": (co_ppm, 9, "ุชุฑููุฒ ูุฑุจููู ูุฑุชูุน ุฌุฏุงู."),
                    "NO": (no, 30, "ูุคุดุฑ ุนูู ุงุญุชุฑุงู ูููุฏ ูุซูู ูุฑูุจุงู.")
                }
                
                alert_found = False
                for name, (val, limit, msg) in pollutants_map.items():
                    if val > limit:
                        st.warning(f"โ๏ธ **ุชูุจูู {name} ูุฑุชูุน ({val}):** {msg}")
                        alert_found = True
                
                if not alert_found:
                    st.success("โ ุฌููุน ุงููููุซุงุช ุงูุชุณุนุฉ ุถูู ุงูุญุฏูุฏ ุงูุขููุฉ ุนูููุงู.")

        else:
            st.error("ูุดู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑุ ุชุฃูุฏ ูู ุชุดุบูู FastAPI.")
    except Exception as e:
        st.error(f"ุญุฏุซ ุฎุทุฃ: ุชุฃูุฏ ูู ุชุดุบูู ุงูุณูุฑูุฑ ุงููุญูู ุจุดูู ุตุญูุญ.")